# ðŸ”¥ **What is `ws`?**

`ws` is the **pure WebSocket library** for Node.js.
It implements the actual WebSocket protocol exactly like the browser.

You create:

* `WebSocketServer` â†’ listens for new connections
* `WebSocket` (socket) â†’ each client connection

Let's break down **EVERYTHING**.

---

# âœ… **1. WebSocketServer (WSS)**

You create a WebSocket server:

```js
import { WebSocketServer } from "ws";

const wss = new WebSocketServer({ port: 8080 });
```

### **What options does it take?**

```js
new WebSocketServer({
  port?: number,
  server?: http.Server,
  host?: string,
  path?: string,
  clientTracking?: boolean, // default true
})
```

### **What does it output?**

An object:

```
wss: WebSocketServer {
   clients: Set<WebSocket>
}
```

### **Main Job:**

Accept WebSocket connections and manage connected clients.

---

# âœ… **2. WebSocketServer Events**

### **2.1 `connection`**

Triggered *when a new client connects.*

```js
wss.on("connection", (socket, req) => {
  console.log("Client connected");
});
```

**Inputs:**

* `socket`: WebSocket object
* `req`: http.IncomingMessage (client IP, headers)

**Outputs:**
Nothing returned. You attach listeners.

---

### **2.2 `listening`**

When server starts listening.

```js
wss.on("listening", () => console.log("WS listening"));
```

---

### **2.3 `error`**

Server errors (port busy, permission, etc.)

```js
wss.on("error", (err) => console.error(err));
```

---

# ðŸ§  **3. `wss.clients`**

A built-in Set containing all connected clients:

```js
for (const client of wss.clients) {
  client.send("Hello all!");
}
```

Used for **broadcasting messages**.

---

# âœ… **4. WebSocket (socket) Methods & Events**

When a client connects, you get a **WebSocket instance** (`socket`).

This is the MAIN object used for communication.

---

# ðŸŽ¯ **4.1 socket.send()**

Send a message to this client.

```js
socket.send("Hello!");
```

### Inputs:

* `data`: string | Buffer | ArrayBuffer | Uint8Array
* `options`? (optional)

  ```js
  { binary?: boolean, compress?: boolean, fin?: boolean }
  ```

### Output:

* returns `true` or `false` depending if socket buffer is full
* throws error if socket is closed

---

# ðŸŽ¯ **4.2 socket.on("message")**

Receive a message from a client.

```js
socket.on("message", (msg) => {
  console.log(msg.toString());
});
```

### Input:

* `msg`: Buffer (you convert to string)

### Output:

nothing, just invokes the callback.

---

# ðŸŽ¯ **4.3 socket.close()**

Close the connection.

```js
socket.close();
```

### Inputs:

```js
socket.close(code?: number, reason?: string);
```

Default:

* code: `1000` (normal closure)
* reason: optional explanation

### What it does:

* sends a close frame to client
* destroys connection

---

# ðŸŽ¯ **4.4 socket.on("close")**

Triggered when client disconnects.

```js
socket.on("close", () => {
  console.log("Client left");
});
```

### Inputs:

* `code` (number)
* `reason` (Buffer)

---

# ðŸŽ¯ **4.5 socket.on("error")**

Triggered on socket-level error.

```js
socket.on("error", (err) => console.error(err));
```

---

# ðŸŽ¯ **4.6 socket.readyState**

Current connection state.

States:

| Value | Meaning    |
| ----- | ---------- |
| `0`   | CONNECTING |
| `1`   | OPEN       |
| `2`   | CLOSING    |
| `3`   | CLOSED     |

---

# ðŸŽ¯ **4.7 socket.ping() / socket.pong()**

Used for heartbeat / keeping connection alive.

Server â†’ client:

```js
socket.ping();
```

Client â†’ server replies automatically.

---

# ðŸŽ¯ **4.8 socket.isAlive (custom usage)**

Used manually:

```js
socket.isAlive = true;

socket.on("pong", () => {
  socket.isAlive = true;
});
```

Used in heartbeat systems.

---

# ðŸ§  **Everything Together (Simple example)**

```js
wss.on("connection", (socket, req) => {
  console.log("Client connected");

  socket.on("message", (msg) => {
    console.log("Received:", msg.toString());
    socket.send("You said: " + msg);
  });

  socket.on("close", () => {
    console.log("Client disconnected");
  });

  socket.on("error", (err) => {
    console.log("Socket error:", err);
  });
});
```

---

# ðŸ† **Advanced `ws` Features (All Important Ones)**

### **1. Broadcasting**

```js
function broadcast(data) {
  for (const client of wss.clients) {
    if (client.readyState === 1) {
      client.send(data);
    }
  }
}
```

---

### **2. JSON messages**

âœ” Reliable
âœ” Easier to read
âœ” Standard practice

```js
socket.send(JSON.stringify({ type: "chat", msg: "hello" }));
```

Receiving:

```js
socket.on("message", (data) => {
  const json = JSON.parse(data);
});
```

---

### **3. Ping/Pong heartbeat**

Used to detect dead clients.

```js
setInterval(() => {
  for (const client of wss.clients) {
    if (!client.isAlive) return client.terminate();
    client.isAlive = false;
    client.ping();
  }
}, 30000);
```

---

### **4. Binary Data**

Send images, files, game packets:

```js
socket.send(Buffer.from([1, 2, 3, 4]));
```

---

# ðŸ“Œ **Summary Table (Ultimate Explanation)**

| Feature                 | Input         | Output          | Purpose             |
| ----------------------- | ------------- | --------------- | ------------------- |
| `new WebSocketServer()` | options       | server instance | Create WS server    |
| `wss.on("connection")`  | socket        | none            | Handle new client   |
| `socket.send()`         | text/binary   | true/false      | Send message        |
| `socket.on("message")`  | Buffer        | none            | Receive message     |
| `socket.close()`        | code + reason | none            | Close connection    |
| `socket.on("close")`    | code + reason | none            | Client disconnected |
| `socket.on("error")`    | error         | none            | Error handling      |
| `socket.ping()`         | none          | pong            | Heartbeat           |
| `socket.readyState`     | none          | number          | Connection status   |
| `wss.clients`           | none          | Set<WebSocket>  | List of clients     |
